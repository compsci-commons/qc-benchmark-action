name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches-ignore: []

jobs:
  linting:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          # Full git history is needed to get a proper list of changed files within `super-linter`
          fetch-depth: 0
      - name: Lint Code Base
        uses: github/super-linter@v4
        env:
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_BASH_EXEC: false
          VALIDATE_BASH: false
          VALIDATE_SHELL_SHFMT: false
          VALIDATE_SNAKEMAKE_LINT: false
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  testing-dummy:
    name: Testing dummy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Download benchmark
        uses: ./
        with:
          task: download
          benchmark_name: dummy
      
      - name: Eval benchmark
        uses: ./
        id: eval
        with:
          task: eval
          benchmark_name: dummy
          results_path: bar.txt
      
      - env:
          REPORT: ${{ steps.eval.outputs.report }}
        run: |
          cat "$REPORT"

  testing-giab-download:
    name: Testing giab-na12878-exome
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Restore benchmark resources from cache
        id: cache
        uses: martijnhols/actions-cache/restore@v3
        with:
          path: benchmark-data/giab-na12878-exome/resources
          key: giab-resources-${{ hashFiles('benchmarks/giab-na12878-exome/workflow/**') }}-${{ hashFiles('benchmarks/giab-na12878-exome/config/**') }}-${{ hashFiles('benchmarks/giab-na12878-exome/*.sh') }}

      - name: Download benchmark
        uses: ./
        id: download
        with:
          task: download
          benchmark_name: giab-na12878-exome

      - name: Save benchmark resources to cache
        if: steps.cache.outputs.cache-hit != 'true'
        uses: martijnhols/actions-cache/save@v3
        with:
          path: benchmark-data/giab-na12878-exome/resources
          key: ${{ steps.cache.outputs.primary-key }}

      - name: Commit and push snakemake cache to repo
        uses: EndBug/add-and-commit@v7
        add: benchmarks/giab-na12878-exome/snakemake-cache
        push: true

      - name: Eval benchmark
        uses: ./
        id: eval
        with:
          task: eval
          benchmark_name: giab-na12878-exome
          results_path: benchmark-data/giab-na12878-exome/resources/variants/truth.vcf
